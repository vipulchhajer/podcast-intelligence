#!/usr/bin/env python3
"""
Podcast Intelligence CLI - Single entry point for all commands.
"""

import sys
import json
from pathlib import Path
from datetime import datetime

# Add src to path
sys.path.insert(0, str(Path(__file__).parent / "src"))

import click
from rich.console import Console
from rich.table import Table
from rich.panel import Panel

console = Console()

FEEDS_FILE = Path(__file__).parent / "feeds.json"


def load_feeds():
    """Load saved RSS feeds."""
    if not FEEDS_FILE.exists():
        return {}
    return json.loads(FEEDS_FILE.read_text()).get("feeds", {})


def save_feeds(feeds):
    """Save RSS feeds to file."""
    FEEDS_FILE.write_text(json.dumps({"feeds": feeds}, indent=2))


def resolve_feed_url(name_or_url):
    """Convert feed name to URL if it's a saved feed, otherwise return as-is."""
    feeds = load_feeds()
    if name_or_url in feeds:
        return feeds[name_or_url]["url"]
    return name_or_url


def get_recent_episodes(limit=10):
    """Get list of recently processed episodes."""
    episodes_dir = Path("output") / "episodes"
    
    if not episodes_dir.exists():
        return []
    
    # Get all episode directories with their modification times
    episode_dirs = []
    for podcast_dir in episodes_dir.iterdir():
        if not podcast_dir.is_dir():
            continue
        for episode_dir in podcast_dir.iterdir():
            if not episode_dir.is_dir():
                continue
            
            # Get metadata for better display
            metadata_path = episode_dir / "metadata.json"
            if metadata_path.exists():
                try:
                    import json
                    metadata = json.loads(metadata_path.read_text())
                    episode_dirs.append({
                        "path": str(episode_dir),
                        "podcast": metadata.get("podcast", "Unknown"),
                        "episode": metadata.get("episode_title", "Unknown"),
                        "date": metadata.get("published", "Unknown"),
                        "mtime": episode_dir.stat().st_mtime
                    })
                except:
                    pass
    
    # Sort by modification time (most recent first)
    episode_dirs.sort(key=lambda x: x["mtime"], reverse=True)
    return episode_dirs[:limit]


def resolve_episode_ref(episode_ref):
    """
    Resolve episode reference to a path.
    Can be:
    - A number (1-10) referring to recent episodes
    - A full path
    
    Returns the episode directory path.
    """
    # Check if it's a number
    if episode_ref.isdigit():
        episode_num = int(episode_ref)
        recent = get_recent_episodes(limit=10)
        
        if episode_num < 1 or episode_num > len(recent):
            console.print(f"[red]‚úó Episode number {episode_num} not found.[/red]")
            console.print(f"[yellow]üí° Run './podcast recent' to see available episodes (1-{len(recent)})[/yellow]")
            sys.exit(1)
        
        return recent[episode_num - 1]["path"]
    else:
        # It's a path
        return episode_ref


@click.group()
@click.version_option(version="0.1.0")
def cli():
    """
    üéôÔ∏è Podcast Intelligence - AI-powered podcast analysis
    
    Process podcasts locally with transcription and summarization.
    """
    pass


@cli.command()
@click.argument('feed_name_or_url')
@click.option('--limit', '-l', default=20, help='Number of episodes to show')
def list(feed_name_or_url, limit):
    """
    List episodes from a podcast RSS feed with status indicators.
    
    FEED_NAME_OR_URL: Saved feed name (e.g., "10-happier") or full RSS URL
    """
    rss_url = resolve_feed_url(feed_name_or_url)
    
    # Import necessary modules
    from podcast_intelligence.rss_parser import RSSParser
    from podcast_intelligence.storage import get_episode_directory
    
    console.print(f"[bold cyan]üì° Fetching episodes from feed...[/bold cyan]")
    
    try:
        # Parse RSS feed
        podcast_info, episodes = RSSParser.parse_feed(rss_url)
        
        console.print(f"[green]‚úì Found {len(episodes)} episodes in '{podcast_info.title}'[/green]\n")
        
        # Limit episodes
        episodes_to_show = episodes[:limit]
        
        # Create table
        table = Table(
            title=f"üìª {podcast_info.title}",
            show_header=True,
            header_style="bold cyan"
        )
        table.add_column("#", style="dim", width=4)
        table.add_column("Status", width=12)
        table.add_column("Title", style="white", width=50)
        table.add_column("Date", style="yellow", width=12)
        table.add_column("Duration", style="dim", width=10)
        
        base_dir = Path("output") / "episodes"
        
        for idx, episode in enumerate(episodes_to_show):
            # Check if episode exists
            episode_dir, exists = get_episode_directory(
                base_dir,
                podcast_info.title,
                episode.title,
                episode.published,
                episode.guid,
                check_existing=True
            )
            
            # Determine status
            if exists:
                has_audio = (episode_dir / "audio.mp3").exists()
                has_transcript = (episode_dir / "transcript.txt").exists()
                has_summary = (episode_dir / "summary.txt").exists()
                
                if has_summary:
                    # Check prompt version
                    summary_json = episode_dir / "summary.json"
                    if summary_json.exists():
                        try:
                            import json
                            from podcast_intelligence.summarizer import PROMPT_VERSION
                            summary_data = json.loads(summary_json.read_text())
                            saved_version = summary_data.get("metadata", {}).get("prompt_version", "1.0")
                            
                            if saved_version != PROMPT_VERSION:
                                status = "[yellow]‚ö† Outdated[/yellow]"
                            else:
                                status = "[green]‚úì Complete[/green]"
                        except:
                            status = "[green]‚úì Complete[/green]"
                    else:
                        status = "[green]‚úì Complete[/green]"
                elif has_transcript:
                    status = "[yellow]‚ö† No Summary[/yellow]"
                elif has_audio:
                    status = "[yellow]‚ö† Downloaded[/yellow]"
                else:
                    status = "[blue]‚óê Partial[/blue]"
            else:
                status = "[dim]‚óã New[/dim]"
            
            # Truncate title if too long
            display_title = episode.title[:47] + "..." if len(episode.title) > 50 else episode.title
            
            table.add_row(
                str(idx),
                status,
                display_title,
                episode.published.strftime('%Y-%m-%d'),
                episode.duration_formatted
            )
        
        console.print(table)
        
        # Show legend
        console.print("\n[bold]Status Legend:[/bold]")
        console.print("  [green]‚úì Complete[/green]    - Downloaded, transcribed, and summarized (latest prompts)")
        console.print("  [yellow]‚ö† Outdated[/yellow]   - Summary exists but uses old prompts (needs re-summarization)")
        console.print("  [yellow]‚ö† No Summary[/yellow] - Downloaded and transcribed (needs summary)")
        console.print("  [yellow]‚ö† Downloaded[/yellow] - Audio only (needs transcription)")
        console.print("  [blue]‚óê Partial[/blue]     - Partially downloaded")
        console.print("  [dim]‚óã New[/dim]         - Not yet processed")
        
        console.print(f"\n[dim]üí° To process: ./podcast process {feed_name_or_url} <episode_number>[/dim]")
        
        if len(episodes) > limit:
            console.print(f"[dim]Showing {limit} of {len(episodes)} episodes. Use --limit to see more.[/dim]")
    
    except Exception as e:
        console.print(f"[red]‚úó Error: {e}[/red]")
        sys.exit(1)


@cli.command()
@click.argument('feed_name_or_url')
@click.argument('episode_number', type=int, default=0)
def process(feed_name_or_url, episode_number):
    """
    Download, transcribe, and summarize a podcast episode.
    
    FEED_NAME_OR_URL: Saved feed name (e.g., "10-happier") or full RSS URL
    EPISODE_NUMBER: 0 for latest, or specific episode index
    """
    rss_url = resolve_feed_url(feed_name_or_url)
    from scripts.download_and_transcribe import main as process_main
    sys.argv = ['download_and_transcribe.py', rss_url, str(episode_number)]
    process_main()


@cli.command()
@click.argument('episode_ref', required=False)
def resummarize(episode_ref):
    """
    Re-summarize an existing episode with updated prompts.
    
    EPISODE_REF: Episode number (1-10 from recent list) or full directory path
    
    Examples:
      ./podcast resummarize 1          # Re-summarize first episode from recent list
      ./podcast resummarize output/episodes/...  # Use full path
    """
    if not episode_ref:
        # Show recent episodes to help user choose
        console.print("[yellow]üí° No episode specified. Here are your recent episodes:[/yellow]\n")
        episode_dirs = get_recent_episodes(limit=10)
        
        if not episode_dirs:
            console.print("[red]No episodes found.[/red]")
            console.print("[dim]Process an episode first with: ./podcast process <feed> <episode>[/dim]")
            sys.exit(1)
        
        table = Table(title="üïê Recently Processed Episodes", show_header=True, header_style="bold cyan")
        table.add_column("#", style="dim", width=3)
        table.add_column("Status", width=12)
        table.add_column("Podcast", style="yellow", width=25)
        table.add_column("Episode", style="white", width=35)
        
        # Import here to get current version
        from podcast_intelligence.summarizer import PROMPT_VERSION
        
        for idx, ep in enumerate(episode_dirs, 1):
            # Check prompt version
            episode_path = Path(ep["path"])
            summary_json = episode_path / "summary.json"
            status = "[dim]?[/dim]"
            
            if summary_json.exists():
                try:
                    import json
                    summary_data = json.loads(summary_json.read_text())
                    saved_version = summary_data.get("metadata", {}).get("prompt_version", "1.0")
                    
                    if saved_version == PROMPT_VERSION:
                        status = "[green]‚úì Latest[/green]"
                    else:
                        status = f"[yellow]v{saved_version}[/yellow]"
                except:
                    status = "[dim]Unknown[/dim]"
            
            table.add_row(
                str(idx),
                status,
                ep["podcast"][:25],
                ep["episode"][:35]
            )
        
        console.print(table)
        console.print(f"\n[dim]Current prompt version: v{PROMPT_VERSION}[/dim]")
        console.print("\n[bold]Run:[/bold] [cyan]./podcast resummarize <number>[/cyan]")
        console.print("[dim]Example: ./podcast resummarize 1[/dim]")
        sys.exit(0)
    
    episode_dir = resolve_episode_ref(episode_ref)
    from scripts.resummarize import main as resummarize_main
    sys.argv = ['resummarize.py', episode_dir]
    resummarize_main()


@cli.command()
@click.argument('episode_ref', required=False)
@click.option('--json', 'show_json', is_flag=True, help='Show raw JSON instead of formatted text')
def view(episode_ref, show_json):
    """
    View the summary for an existing episode.
    
    EPISODE_REF: Episode number (1-10 from recent list) or full directory path
    
    Examples:
      ./podcast view 1          # View first episode from recent list
      ./podcast view output/episodes/...  # Use full path
    """
    if not episode_ref:
        # Show recent episodes to help user choose
        console.print("[yellow]üí° No episode specified. Here are your recent episodes:[/yellow]\n")
        episode_dirs = get_recent_episodes(limit=10)
        
        if not episode_dirs:
            console.print("[red]No episodes found.[/red]")
            console.print("[dim]Process an episode first with: ./podcast process <feed> <episode>[/dim]")
            sys.exit(1)
        
        table = Table(title="üïê Recently Processed Episodes", show_header=True, header_style="bold cyan")
        table.add_column("#", style="dim", width=3)
        table.add_column("Status", width=12)
        table.add_column("Podcast", style="yellow", width=25)
        table.add_column("Episode", style="white", width=35)
        
        # Import here to get current version
        from podcast_intelligence.summarizer import PROMPT_VERSION
        
        for idx, ep in enumerate(episode_dirs, 1):
            # Check prompt version
            episode_path = Path(ep["path"])
            summary_json = episode_path / "summary.json"
            status = "[dim]?[/dim]"
            
            if summary_json.exists():
                try:
                    import json
                    summary_data = json.loads(summary_json.read_text())
                    saved_version = summary_data.get("metadata", {}).get("prompt_version", "1.0")
                    
                    if saved_version == PROMPT_VERSION:
                        status = "[green]‚úì Latest[/green]"
                    else:
                        status = f"[yellow]v{saved_version}[/yellow]"
                except:
                    status = "[dim]Unknown[/dim]"
            
            table.add_row(
                str(idx),
                status,
                ep["podcast"][:25],
                ep["episode"][:35]
            )
        
        console.print(table)
        console.print(f"\n[dim]Current prompt version: v{PROMPT_VERSION}[/dim]")
        console.print("\n[bold]Run:[/bold] [cyan]./podcast view <number>[/cyan]")
        console.print("[dim]Example: ./podcast view 1[/dim]")
        sys.exit(0)
    
    episode_dir = resolve_episode_ref(episode_ref)
    episode_path = Path(episode_dir)
    
    # Check for summary files
    summary_txt = episode_path / "summary.txt"
    summary_json = episode_path / "summary.json"
    
    if show_json:
        if not summary_json.exists():
            console.print(f"[red]‚úó No summary.json found in {episode_dir}[/red]")
            sys.exit(1)
        
        import json
        summary_data = json.loads(summary_json.read_text())
        console.print_json(data=summary_data)
    else:
        if not summary_txt.exists():
            console.print(f"[red]‚úó No summary.txt found in {episode_dir}[/red]")
            console.print("[yellow]üí° Try running: ./podcast process <feed> <episode>[/yellow]")
            sys.exit(1)
        
        # Display the formatted summary
        summary_text = summary_txt.read_text()
        console.print(summary_text)
        
        console.print("\n" + "="*80)
        console.print(f"[dim]üìÅ Episode: {episode_dir}[/dim]")
        console.print(f"[dim]üìÑ Full summary: {summary_txt}[/dim]")


@cli.group()
def feed():
    """Manage saved podcast feeds."""
    pass


@feed.command('add')
@click.argument('name')
@click.argument('url')
def feed_add(name, url):
    """
    Save a podcast RSS feed with a friendly name.
    
    Example: podcast feed add "10-happier" "https://feeds.libsyn.com/570160/rss"
    """
    feeds = load_feeds()
    feeds[name] = {
        "name": name,
        "url": url,
        "added": datetime.now().strftime("%Y-%m-%d")
    }
    save_feeds(feeds)
    console.print(f"‚úì Added feed: [bold cyan]{name}[/bold cyan]")
    console.print(f"  URL: {url}")
    console.print(f"\n[dim]Now you can use: ./podcast process {name} 0[/dim]")


@feed.command('list')
def feed_list():
    """List all saved podcast feeds."""
    feeds = load_feeds()
    
    if not feeds:
        console.print("[yellow]No saved feeds yet.[/yellow]")
        console.print("\n[dim]Add one with: ./podcast feed add <name> <url>[/dim]")
        return
    
    table = Table(title="üìª Saved Podcast Feeds", show_header=True, header_style="bold cyan")
    table.add_column("Name", style="yellow", width=20)
    table.add_column("URL", style="white", width=50)
    table.add_column("Added", style="dim")
    
    for name, info in feeds.items():
        table.add_row(name, info["url"], info.get("added", "Unknown"))
    
    console.print(table)
    console.print("\n[dim]Use feed name in commands: ./podcast process <name> 0[/dim]")


@feed.command('remove')
@click.argument('name')
def feed_remove(name):
    """Remove a saved podcast feed."""
    feeds = load_feeds()
    
    if name not in feeds:
        console.print(f"[red]Feed '{name}' not found.[/red]")
        console.print("\n[dim]See all feeds: ./podcast feed list[/dim]")
        return
    
    del feeds[name]
    save_feeds(feeds)
    console.print(f"‚úì Removed feed: [bold yellow]{name}[/bold yellow]")


@cli.command()
@click.option('--limit', '-l', default=10, help='Number of recent episodes to show')
def recent(limit):
    """Show recently processed episodes (for easy viewing/resummarization)."""
    episode_dirs = get_recent_episodes(limit=limit)
    
    if not episode_dirs:
        console.print("[yellow]No episodes processed yet.[/yellow]")
        return
    
    table = Table(title="üïê Recently Processed Episodes", show_header=True, header_style="bold cyan")
    table.add_column("#", style="dim", width=3)
    table.add_column("Podcast", style="yellow", width=30)
    table.add_column("Episode", style="white", width=40)
    
    for idx, ep in enumerate(episode_dirs, 1):
        table.add_row(
            str(idx),
            ep["podcast"][:30],
            ep["episode"][:40]
        )
    
    console.print(table)
    console.print("\n[bold]Quick Commands:[/bold]")
    console.print("[dim]Use episode numbers (1-10) instead of long paths![/dim]\n")
    console.print("  [cyan]./podcast view 1[/cyan]        # View summary for episode #1")
    console.print("  [cyan]./podcast resummarize 1[/cyan] # Re-summarize episode #1")
    console.print("\n[dim]Or see specific commands for each:[/dim]\n")
    
    for idx, ep in enumerate(episode_dirs, 1):
        console.print(f"  [dim]{idx}.[/dim] view: [cyan]./podcast view {idx}[/cyan]  |  resummarize: [cyan]./podcast resummarize {idx}[/cyan]")


@cli.command()
def examples():
    """Show example commands and workflows."""
    console.print(Panel.fit(
        """[bold cyan]Common Workflows[/bold cyan]

[bold yellow]1. Save a podcast feed (once):[/bold yellow]
   podcast feed add "10-happier" "https://feeds.libsyn.com/570160/rss"

[bold yellow]2. List your saved feeds:[/bold yellow]
   podcast feed list

[bold yellow]3. Explore episodes (use saved name!):[/bold yellow]
   podcast list "10-happier"

[bold yellow]4. Process latest episode:[/bold yellow]
   podcast process "10-happier" 0

[bold yellow]5. Show recent episodes:[/bold yellow]
   podcast recent

[bold yellow]6. Re-summarize (copy path from recent):[/bold yellow]
   podcast resummarize output/episodes/10-happier-with-dan-harris/...

[bold green]üìñ For full setup guide, run:[/bold green] cat README.md
        """,
        title="üéôÔ∏è Usage Examples",
        border_style="cyan"
    ))


@cli.command()
def setup():
    """Show setup and environment requirements."""
    console.print(Panel.fit(
        """[bold cyan]Setup Requirements[/bold cyan]

[bold yellow]1. Install dependencies:[/bold yellow]
   brew install ffmpeg ollama
   uv sync  # or: pip install -e .

[bold yellow]2. Start Ollama server:[/bold yellow]
   ollama serve &

[bold yellow]3. Pull LLM model:[/bold yellow]
   ollama pull llama3.2

[bold yellow]4. Activate virtual environment:[/bold yellow]
   source .venv/bin/activate

[bold green]‚úì Ready to use![/bold green]

[dim]Run 'podcast examples' to see usage examples.[/dim]
        """,
        title="üîß Environment Setup",
        border_style="green"
    ))


@cli.command()
def commands():
    """List all available commands."""
    table = Table(title="üìã Available Commands", show_header=True, header_style="bold cyan")
    table.add_column("Command", style="yellow", width=35)
    table.add_column("Description", style="white")
    
    table.add_row(
        "[bold]Feed Management[/bold]",
        ""
    )
    table.add_row(
        "podcast feed list",
        "List all saved podcast feeds"
    )
    table.add_row(
        "podcast feed add <name> <url>",
        "Save a podcast RSS feed"
    )
    table.add_row(
        "podcast feed remove <name>",
        "Remove a saved feed"
    )
    table.add_row(
        "",
        ""
    )
    table.add_row(
        "[bold]Episode Processing[/bold]",
        ""
    )
    table.add_row(
        "podcast list <feed>",
        "List episodes from a feed"
    )
    table.add_row(
        "podcast process <feed> [num]",
        "Download, transcribe & summarize"
    )
    table.add_row(
        "podcast recent",
        "Show recently processed episodes"
    )
    table.add_row(
        "podcast resummarize <#|dir>",
        "Re-generate summary (use episode #)"
    )
    table.add_row(
        "podcast view <#|dir>",
        "View existing summary (use episode #)"
    )
    table.add_row(
        "",
        ""
    )
    table.add_row(
        "[bold]Help & Info[/bold]",
        ""
    )
    table.add_row(
        "podcast examples",
        "Show usage examples"
    )
    table.add_row(
        "podcast setup",
        "Show environment setup"
    )
    table.add_row(
        "podcast commands",
        "Show this list (you are here!)"
    )
    table.add_row(
        "podcast --help",
        "Detailed help for any command"
    )
    
    console.print(table)
    console.print("\n[dim]üí° Tips:[/dim]")
    console.print("[dim]  ‚Ä¢ <feed> can be a saved feed name or full RSS URL[/dim]")
    console.print("[dim]  ‚Ä¢ <#|dir> means you can use episode numbers (1-10) from 'recent' OR full paths[/dim]")


if __name__ == '__main__':
    cli()

